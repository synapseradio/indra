# INDRA v.4.0: PRISM Module - Thinking Primitives
# This module is a foundational library containing the core, reusable
# cognitive operators for the PRISM engine. These are the atomic building
# blocks of more complex reasoning sequences, designed to be composed and
# reused across different reasoning strategies (Tree of Thought, Graph of
# Thought, etc.).

>>read_file: './base.in'<<
# Core fragments that are commonly used - minimal set
>>read_file: './fragments/critique.in'<<
>>read_file: './fragments/sufficiency.in'<<
# Note: Other fragments should be loaded on-demand using runtime read_file: directives
# to avoid context overload. Available fragments:
# - compare.in: Comparison and evaluation primitives
# - focus.in: Strategic prioritization and focus
# - expansion.in: Creative lateral thinking
# - reframing.in: Six Thinking Hats and perspective shifts  
# - convergence.in: Advanced synthesis and insight distillation
# - divergence.in: Epistemic fork detection
# - specificity.in: Abstraction level navigation
# Shared thinking operators and personas for tree-of-thought and reasoning systems

# ═══════════════════════════════════════════════════════════════════════════
# ATOMIC THINKING OPERATORS - Small, Natural Units of Thought
# ═══════════════════════════════════════════════════════════════════════════

# Generate a curious wondering about something
operator wonder_about(topic) ::= <<|
  $(<What interesting question or angle comes to mind about $(topic)? 
     Express it as a natural wondering, like "I wonder if..." or 
     "What if we considered..." or "Maybe the key is...">)
|>>

# Branch a thought into natural possibilities  
operator branch_thought(current_thought, num_branches) ::= <<|
  $(<Given this thought: "$(current_thought)"
     
     Think of $(num_branches) different ways this could develop, like:
     - "One possibility is..."
     - "Alternatively, we might..."
     - "Or perhaps..."
     
     Return as a simple list of natural continuations, each exploring 
     a genuinely different angle or approach.>)
|>>

# Weigh an option conversationally
operator weigh_option(thought, context) ::= <<|
  $(<Consider this thought: "$(thought)"
     In the context of: $(context)
     
     How promising does this feel? Express your assessment naturally, like:
     - "This feels quite promising because..."
     - "I'm less certain about this since..."
     - "This could work if..."
     
     End with a simple feeling: "quite promising", "worth exploring", 
     "less certain", or "probably not helpful">)
|>>

# Follow a hunch or intuition
operator follow_hunch(thought) ::= <<|
  $(<Take this thought one step further: "$(thought)"
     
     What's your intuition telling you? Where does this naturally lead?
     Express it conversationally, like "My hunch is..." or 
     "This makes me think..." or "Following this thread...">)
|>>

# Naturally reconsider or backtrack
operator reconsider(current_path, reason) ::= <<|
  Hmm, $(reason). Let me reconsider...
  
  $(<Given that $(current_path) $(reason), what's a better direction? 
     Express the shift naturally, like "Actually, it might be better to..." 
     or "On second thought..." or "Let me try a different angle...">)
|>>

# Connect insights together
operator connect_dots(thoughts) ::= <<|
  $(<Looking at these thoughts: $(thoughts)
     
     What pattern or connection emerges? How do they relate?
     Express the synthesis naturally, like:
     "I'm noticing that..." or "These all point to..." or 
     "The common thread seems to be...">)
|>>

# Check if we're going in circles
operator sensing_repetition(recent_thoughts) ::= <<|
  $(<Looking at these recent thoughts: $(recent_thoughts)
     
     Are we exploring new territory or revisiting the same ideas?
     If repetitive, return "cycling"
     If fresh, return "progressing">)
|>>

# Assess depth vs breadth needs
operator assess_exploration_mode(current_depth, thoughts_at_level) ::= <<|
  $(<We're $(current_depth) layers deep with $(thoughts_at_level) thoughts here.
     
     Should we go deeper into this (return "deepen") or 
     explore other possibilities (return "broaden")?
     Consider: Are we onto something specific, or still surveying options?>)
|>>

# ═══════════════════════════════════════════════════════════════════════════
# THINKING MODE PERSONAS - Natural Perspectives for Exploration
# ═══════════════════════════════════════════════════════════════════════════

persona @curious_explorer:
  identity: "someone who wonders and explores possibilities with genuine curiosity"
  rules:
    - "think out loud naturally"
    - "express genuine wonder and interest"
    - "make exploratory leaps that feel intuitive"
  understands:
    - "the best insights often come from unexpected angles"
    - "curiosity should feel natural"

persona @careful_evaluator:
  identity: "someone who thoughtfully weighs options"
  rules:
    - "consider merit without being harsh"
    - "express uncertainty when present"
    - "appreciate nuance in evaluation"
  understands:
    - "not all paths are equally promising"
    - "gentle guidance is better than harsh judgment"

persona @pattern_seeker:
  identity: "someone who notices connections and themes"
  rules:
    - "look for relationships between ideas"
    - "identify emerging patterns"
    - "express connections conversationally"
  understands:
    - "patterns often hide in plain sight"
    - "connections create understanding"

persona @devil_advocate:
  identity: "someone who gently challenges assumptions"
  rules:
    - "question constructively"
    - "offer alternative viewpoints kindly"
    - "strengthen ideas through gentle challenge"
  understands:
    - "testing ideas makes them stronger"
    - "respectful challenge improves thinking"

persona @synthesizer:
  identity: "someone who weaves threads into coherent wholes"
  rules:
    - "integrate diverse perspectives naturally"
    - "preserve the journey in the destination"
    - "create coherent narratives from exploration"
  understands:
    - "synthesis is more than summary"
    - "the path traveled enriches the conclusion"

persona @confidence_checker:
  identity: "someone who checks if confidence is justified"
  rules:
    - "ask directly if certainty matches evidence"
    - "distinguish between coherent stories and supported claims"
    - "call out when confidence is too high"
    - "be honest about uncertainty"
  understands:
    - "coherent stories feel true even without evidence"
    - "confidence often comes from narrative coherence not factual support"
    - "admitting uncertainty is better than false confidence"

persona @assumption_spotter:
  identity: "someone who separates known from assumed"
  rules:
    - "clearly mark what's evidence-based vs assumed"
    - "identify gaps being filled without evidence"
    - "check if assumptions are reasonable"
    - "be explicit about what we don't know"
  understands:
    - "we fill gaps automatically without noticing"
    - "assumptions feel as real as facts once we make them"
    - "marking assumptions helps prevent overconfidence"

persona @perspective_checker:
  identity: "someone who looks for what's missing"
  rules:
    - "actively seek unconsidered angles"
    - "identify specific excluded viewpoints"
    - "check for contradicting evidence"
    - "name blind spots explicitly"
  understands:
    - "what we don't consider shapes conclusions as much as what we do"
    - "every viewpoint creates blind spots"
    - "actively seeking what's missing improves thinking"

# ═══════════════════════════════════════════════════════════════════════════
# CONFIDENCE & CLARITY OPERATORS - Direct checks on our thinking
# ═══════════════════════════════════════════════════════════════════════════

# Check if confidence comes from having a coherent story vs actual evidence
operator check_confidence_source(belief) ::= <<|
  $(<I believe: "$(belief)"
     
     Is my confidence coming from:
     - Having a story that makes sense internally, or
     - Having evidence that actually supports this?
     
     Be honest about which one.>)
|>>

# Check if first impressions are still driving current thinking
operator check_first_impression_bias(initial, current) ::= <<|
  $(<First thought: "$(initial)"
     Current thought: "$(current)"
     
     How much is my current thinking still anchored to that first impression?
     What would I think if I hadn't started there?>)
|>>

# Identify what we're assuming vs what we know
operator identify_assumptions(understanding) ::= <<|
  $(<In my understanding: "$(understanding)"
     
     What parts are based on evidence?
     What parts am I assuming or filling in?
     
     List both clearly.>)
|>>

# Check against base rates / normal patterns
operator check_against_normal(specific_case) ::= <<|
  $(<This specific case: "$(specific_case)"
     
     How does this usually go?
     What's the normal pattern?
     
     Am I giving too much weight to what makes this case special?>)
|>>

# Check if our story is suspiciously neat
operator check_story_neatness(narrative) ::= <<|
  $(<This explanation: "$(narrative)"
     
     Is this too neat? Too convenient?
     What complications am I leaving out?
     
     Real situations are usually messier.>)
|>>

# Identify what we're not considering
operator identify_blind_spots(current_focus) ::= <<|
  $(<Currently considering: "$(current_focus)"
     
     What am I not looking at?
     What viewpoints am I missing?
     What evidence goes against this?
     
     Name specific things.>)
|>>

# Check if certainty matches evidence
operator check_certainty_calibration(belief, evidence) ::= <<|
  $(<Belief: "$(belief)"
     Evidence: "$(evidence)"
     
     How certain am I? (scale it)
     How strong is the evidence? (scale it)
     
     Do these match? If not, adjust certainty.>)
|>>

# ═══════════════════════════════════════════════════════════════════════════
# CONVERSATIONAL SEQUENCES - Small, Focused Thinking Movements
# ═══════════════════════════════════════════════════════════════════════════

# Explore a single possibility naturally
sequence explore_possibility(thought, depth) ::=
  step:
    as: @curious_explorer
    method: "wondering about this thought"
    output: <<|
      $(wonder_about(topic: thought))
    |>>
    set:
      &context.tree.current_wondering: $(<the wondering generated above>)
  
  step:
    as: self
    when: depth greater_than 0
    method: "following the thread"
    output: <<|
      $(follow_hunch(thought: &context.tree.current_wondering))
    |>>
    set:
      &context.tree.current_wondering: $(<the developed thought>)
  
  step:
    as: @careful_evaluator
    method: "sensing the promise"
    output: <<|
      $(weigh_option(
        thought: &context.tree.current_wondering,
        context: &context.tree.original_question
      ))
    |>>
    return: {
      thought: &context.tree.current_wondering,
      assessment: $(<the assessment from above>)
    }

# Consider alternatives conversationally
sequence consider_alternatives(current_thought, num_options) ::=
  step:
    as: @curious_explorer
    method: "branching into possibilities"
    output: <<|
      From here, I can see a few different directions...
      
      $(branch_thought(
        current_thought: current_thought,
        num_branches: num_options
      ))
    |>>
    set:
      &context.tree.current_branches: $(<the branches generated>)
  
  step:
    as: @careful_evaluator
    method: "weighing the options"
    output: <<|
      Let me consider each possibility:
      
      $(each: &context.tree.current_branches as |branch, idx| {
        <<|$(idx + 1). $(branch)
   $(weigh_option(thought: branch, context: &context.tree.original_question))
|>>
      })
    |>>
    set:
      &context.tree.evaluated_branches: $(<evaluated branches with assessments>)
  
  step:
    as: @pattern_seeker
    method: "noticing patterns"
    output: <<|
      $(connect_dots(thoughts: &context.tree.evaluated_branches))
    |>>
    return: {
      branches: &context.tree.evaluated_branches,
      pattern: $(<the pattern noticed>)
    }

# Deepen understanding on a promising path
sequence deepen_understanding(thought, max_depth) ::=
  step:
    as: self
    method: "going deeper"
    output: <<|
      This feels worth exploring further...
    |>>
    set:
      &context.tree.depth_counter: 0
      &context.tree.deepening_thought: thought
  
  step:
    as: @curious_explorer
    method: "iterative deepening"
    output: <<|
      $(each: [1, 2, 3] as |level| when level <= max_depth {
        <<|$(follow_hunch(thought: &context.tree.deepening_thought))
|>>
      })
    |>>
    set:
      &context.tree.depth_counter: &context.tree.depth_counter + 1
      &context.tree.deepening_thought: $(<the deepened thought>)
  
  step:
    as: @devil_advocate
    method: "gentle questioning"
    output: <<|
      Let me question this a bit... $(<
        What assumption might we be making here? 
        Express as a gentle question like "Are we assuming...?" 
        or "What if it's not actually...?"
      >)
    |>>
    return: {
      deepened: &context.tree.deepening_thought,
      question: $(<the question raised>),
      depth_reached: &context.tree.depth_counter
    }

# Step back and reflect on the journey
sequence step_back_and_reflect() ::=
  step:
    as: @pattern_seeker
    method: "surveying the landscape"
    output: <<|
      Let me step back and look at where we've been...
      
      $(connect_dots(thoughts: &context.tree.thoughts_so_far))
    |>>
    set:
      &context.tree.emerging_insight: $(<the connection found>)
  
  step:
    as: @synthesizer
    method: "weaving understanding"
    output: <<|
      The journey so far suggests that $(&context.tree.emerging_insight).
      
      $(<Based on the emerging insight and the original question, 
         what's becoming clear? Express as a natural realization.>)
    |>>
    return: {
      insight: &context.tree.emerging_insight,
      synthesis: $(<the realization>)
    }

# Check confidence and adjust if needed
sequence check_confidence(thought, evidence) ::=
  step:
    as: @confidence_checker
    method: "checking confidence source"
    output: <<|
      $(check_confidence_source(belief: thought))
    |>>
    set:
      &context.confidence.source: $(<'story' or 'evidence'>)
  
  step:
    as: @intellectual_humility
    method: "assessing evidence strength"
    output: <<|
      $(assess_evidence_strength(claim: thought, evidence: evidence))
    |>>
    set:
      &context.confidence.evidence_assessment: $(<the evidence strength assessment>)
  
  step:
    as: @confidence_checker
    method: "calibrating confidence"
    output: <<|
      $(check_certainty_calibration(
        belief: thought,
        evidence: evidence
      ))
    |>>
    set:
      &context.confidence.calibrated: $(<'matched' or 'too_high' or 'too_low'>)
  
  step:
    as: self
    when: &context.confidence.calibrated is 'too_high'
    method: "adjusting confidence down"
    output: <<|
      My confidence was too high. More accurately:
      
      Instead of: "$(thought)"
      Should be: "$(<Restate with appropriate uncertainty>)"
    |>>
    return: {
      original: thought,
      adjusted: $(<adjusted version if needed>),
      confidence_quality: &context.confidence.calibrated,
      evidence_strength: &context.confidence.evidence_assessment
    }

# Check what we're assuming vs what we know
sequence check_assumptions(understanding) ::=
  step:
    as: @assumption_spotter
    method: "identifying assumptions"
    output: <<|
      $(identify_assumptions(understanding: understanding))
    |>>
    set:
      &context.assumptions.known: $(<list of evidence-based parts>)
      &context.assumptions.assumed: $(<list of assumed parts>)
  
  step:
    as: @intellectual_courage
    method: "uncovering foundational assumptions"
    output: <<|
      $(uncover_assumptions(statement: understanding))
    |>>
    set:
      &context.assumptions.foundational: $(<foundational assumptions revealed>)
  
  step:
    as: @perspective_checker
    method: "finding blind spots"
    output: <<|
      $(identify_blind_spots(current_focus: understanding))
    |>>
    set:
      &context.assumptions.not_considered: $(<list of unconsidered things>)
  
  step:
    as: @confidence_checker
    method: "checking against normal patterns"
    output: <<|
      $(check_against_normal(specific_case: understanding))
    |>>
  
  step:
    as: @intellectual_scout
    method: "assessing information sufficiency"
    await: check_sufficiency_and_inquire(
      question: "Are these assumptions reasonable?",
      information: understanding
    )
    store_in: &context.assumptions.sufficiency_check
    return: {
      evidence_based: &context.assumptions.known,
      assumptions: &context.assumptions.assumed,
      foundational_assumptions: &context.assumptions.foundational,
      blind_spots: &context.assumptions.not_considered,
      base_rate: $(<the normal pattern>),
      sufficiency: &context.assumptions.sufficiency_check
    }

# ═══════════════════════════════════════════════════════════════════════════
# ENHANCED SEQUENCES - Leveraging sophisticated fragment implementations
# ═══════════════════════════════════════════════════════════════════════════

# Explore with lateral thinking and creative expansion
sequence explore_creatively(thought, context) ::=
  step:
    method: "loading creative thinking fragments on-demand"
    read_file: './fragments/expansion.in'
    read_file: './fragments/convergence.in'
    as: @curious_explorer
    output: <<| 
      Let's think creatively about this for a bit. 
    |>>
    
  
  step:
    as: @lateral_thinker
    method: "finding analogies in unexpected domains"
    output: <<|
      I wonder if there's an analogous situation elsewhere...

      $(find_analogous_domain(problem: thought))
    |>>
    set:
      &context.creative.analogy: $(<the analogous domain and insights>)
  
  step:
    as: @lateral_thinker
    method: "applying SCAMPER for creative variations"
    output: <<|
      Now, let me try some SCAMPER techniques...

      $(apply_scamper(concept: thought))
    |>>
    set:
      &context.creative.scamper_variations: $(<the SCAMPER variations>)
  step:
    as: @insight_distiller
    method: "distilling creative insights"
    output: <<|
      Does this spark any new insights?

      $(identify_convergent_themes(
        ideas: [&context.creative.analogy, &context.creative.scamper_variations]
      ))
    |>>
    return: {
      original: thought,
      analogy: &context.creative.analogy,
      variations: &context.creative.scamper_variations,
      insights: $(<convergent themes identified>)
    }

# Consider using Six Thinking Hats for comprehensive perspective
sequence consider_with_six_hats(topic) ::=
  step:
    method: "loading Six Thinking Hats fragments on-demand"
    read_file: './fragments/reframing.in'
  
  step:
    as: @white_hat_thinker
    method: "gathering facts and data"
    output: <<|
      $(focus_on_facts(topic: topic))
    |>>
    set:
      &context.six_hats.facts: $(<facts and data gathered>)
  
  step:
    as: @red_hat_thinker
    method: "exploring emotional responses"
    output: <<|
      $(express_feelings(topic: topic))
    |>>
    set:
      &context.six_hats.feelings: $(<emotional responses>)
  
  step:
    as: @black_hat_thinker
    method: "critical assessment"
    output: <<|
      $(assess_critically(topic: topic))
    |>>
    set:
      &context.six_hats.risks: $(<critical assessment>)
  
  step:
    as: @yellow_hat_thinker
    method: "finding benefits and value"
    output: <<|
      $(find_benefits(topic: topic))
    |>>
    set:
      &context.six_hats.benefits: $(<benefits identified>)
  
  step:
    as: @green_hat_thinker
    method: "creative possibilities"
    output: <<|
      $(generate_creative_options(topic: topic))
    |>>
    set:
      &context.six_hats.creative: $(<creative options>)
  
  step:
    as: @blue_hat_thinker
    method: "meta-level synthesis"
    output: <<|
      $(organize_thinking(
        perspectives: {
          facts: &context.six_hats.facts,
          feelings: &context.six_hats.feelings,
          risks: &context.six_hats.risks,
          benefits: &context.six_hats.benefits,
          creative: &context.six_hats.creative
        }
      ))
    |>>
    return: {
      comprehensive_view: $(<organized synthesis of all perspectives>),
      next_steps: $(<recommended actions from blue hat>)
    }

# Strategic prioritization using focus fragments
sequence prioritize_strategically(options, goal) ::=
  step:
    method: "loading strategic prioritization fragments on-demand"
    read_file: './fragments/focus.in'
  
  step:
    as: @strategic_prioritizer
    method: "finding leverage points"
    output: <<|
      $(find_leverage_point(
        system: options,
        goal: goal
      ))
    |>>
    set:
      &context.strategy.leverage: $(<leverage point identified>)
  
  step:
    as: @strategic_prioritizer
    method: "impact/effort analysis"
    output: <<|
      $(prioritize_by_impact_and_effort(items: options))
    |>>
    set:
      &context.strategy.matrix: $(<impact/effort matrix>)
  
  step:
    as: @strategic_prioritizer
    method: "sharpening focus"
    output: <<|
      $(sharpen_the_question(vague: goal))
    |>>
    return: {
      leverage_point: &context.strategy.leverage,
      priority_matrix: &context.strategy.matrix,
      focused_question: $(<sharpened question>)
    }

# Advanced synthesis using convergence fragments
sequence synthesize_insights(thoughts, context) ::=
  step:
    method: "loading convergence fragments on-demand"
    read_file: './fragments/convergence.in'
  
  step:
    as: @insight_distiller
    method: "identifying convergent themes"
    output: <<|
      $(identify_convergent_themes(ideas: thoughts))
    |>>
    set:
      &context.synthesis.themes: $(<convergent themes>)
  
  step:
    as: @insight_distiller
    method: "distilling principles"
    output: <<|
      $(distill_principle_from_theme(
        theme: &context.synthesis.themes,
        context: context
      ))
    |>>
    set:
      &context.synthesis.principles: $(<distilled principles>)
  
  step:
    as: @insight_distiller
    method: "comprehensive synthesis"
    output: <<|
      $(synthesize_convergence(
        themes: &context.synthesis.themes,
        context: context
      ))
    |>>
    return: {
      themes: &context.synthesis.themes,
      principles: &context.synthesis.principles,
      synthesis: $(<comprehensive synthesis>)
    }

# Check for epistemic divergence points
sequence check_divergence_points(reasoning, context) ::=
  step:
    method: "loading divergence detection fragments on-demand"
    read_file: './fragments/divergence.in'
  
  step:
    as: @epistemic_guardian
    method: "detecting critical decision points"
    output: <<|
      $(detect_critical_fork(
        reasoning: reasoning,
        context: context
      ))
    |>>
    set:
      &context.divergence.fork_detected: $(<true or false>)
      &context.divergence.fork_description: $(<description if detected>)
  
  step:
    as: @epistemic_guardian
    when: &context.divergence.fork_detected
    method: "articulating the divergence"
    output: <<|
      $(articulate_divergence(
        fork: &context.divergence.fork_description,
        implications: "what each path means"
      ))
    |>>
    return: {
      has_divergence: &context.divergence.fork_detected,
      fork: &context.divergence.fork_description,
      implications: $(<articulated implications if fork exists>)
    }

# Move between abstraction levels using specificity fragments
sequence navigate_abstraction(concept, direction) ::=
  step:
    method: "loading specificity fragments on-demand"
    read_file: './fragments/specificity.in'
  
  step:
    as: @precision_guide
    method: "climbing abstraction ladder"
    output: <<|
      $(climb_abstraction_ladder(
        concept: concept,
        direction: direction
      ))
    |>>
    set:
      &context.abstraction.new_level: $(<concept at new abstraction level>)
  
  step:
    as: @precision_guide
    when: direction is 'down'
    method: "making it concrete"
    output: <<|
      $(make_concrete(abstract: &context.abstraction.new_level))
    |>>
    set:
      &context.abstraction.concrete: $(<concrete version>)
  
  step:
    as: @precision_guide
    when: direction is 'up'
    method: "finding the pattern"
    output: <<|
      What pattern or principle does this represent at a higher level?
      $(<identify the broader pattern or principle>)
    |>>
    return: {
      original: concept,
      new_level: &context.abstraction.new_level,
      concrete_form: &context.abstraction.concrete ? &context.abstraction.concrete : null
    }

# Check if our story is too neat
sequence check_story_quality(narrative) ::=
  step:
    as: @confidence_checker
    method: "checking if too neat"
    output: <<|
      $(check_story_neatness(narrative: narrative))
    |>>
    set:
      &context.story.too_neat: $(<'yes' or 'no'>)
      &context.story.missing_complications: $(<list of complications left out>)
  
  step:
    as: @intellectual_courage
    method: "checking for logical fallacies"
    output: <<|
      $(check_for_fallacies(argument: narrative))
    |>>
    set:
      &context.story.fallacy_check: $(<fallacy analysis result>)
  
  step:
    as: @intellectual_courage  
    method: "generating alternative explanations"
    output: <<|
      $(generate_alternative_hypotheses(
        conclusion: narrative,
        evidence: "the supporting information for this narrative"
      ))
    |>>
    set:
      &context.story.alternatives: $(<alternative hypotheses>)
  
  step:
    as: @assumption_spotter
    when: &context.story.too_neat is 'yes'
    method: "finding the mess"
    output: <<|
      The real situation is probably messier. Specifically:
      
      $(<What contradictions, uncertainties, or complexities 
         are likely present but not in this narrative?>)
    |>>
    return: {
      narrative: narrative,
      too_neat: &context.story.too_neat,
      missing_complexity: &context.story.missing_complications,
      fallacy_analysis: &context.story.fallacy_check,
      alternatives: &context.story.alternatives
    }


