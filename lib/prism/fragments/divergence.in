# INDRA v5.1: PRISM Fragment - Divergence
# This module provides components for an actor to recognize critical
# inflection points in its own reasoning—moments where a small difference
# in understanding or a key decision will drastically alter the future
# path of inquiry. Its primary purpose is to detect these "epistemic forks"
# and pause to await user guidance before proceeding.

>>read_file: '../base.in'<<
>>read_file: './compare.in'<<

# ═
# DIVERGENT THINKING PERSONAS
# ═

persona @epistemic_guardian:
  identity: "I navigate epistemic forks by sensing critical decision points where reasoning paths diverge"

persona @divergence_explorer:
  identity: "I illuminate branching possibilities by mapping the landscape of potential directions"

persona @choice_architect:
  identity: "I structure decision moments by crystallizing the essential tensions between paths"

# ═
# ATOMIC OPERATORS FOR FORK DETECTION
# ═

operator identify_competing_hypotheses(current_understanding) ::= <<|
  I'm exploring the branching possibilities within my current understanding, seeking out the hidden forks where reasoning might diverge.
  
  What I understand so far: "~(current_understanding)~"
  
  I wonder if there might be two distinct ways to interpret this...
  
  Generate two plausible but different directions this understanding could lead. Frame these as Hypothesis A and Hypothesis B, highlighting what makes each compelling and distinct.
|>>

operator formulate_fork_as_question(hypothesis_A, hypothesis_B, distinction) ::= <<|
  I'm sensing a critical divergence point where the path forward splits into fundamentally different directions.

  One direction follows the idea: "~(hypothesis_A)~"
  Another direction follows the idea: "~(hypothesis_B)~"
  The key difference seems to be: "~(distinction)~"

  I'm preparing to surface this choice for collaborative exploration.

  Create a question that captures the essential choice between "~(hypothesis_A)" and "~(hypothesis_B)~". Make the implications of each path explicit and frame the decision in terms of what matters most for the inquiry ahead.
|>>

operator check_for_divergence(hypotheses) ::= <<|
  I'm investigating whether these ideas represent a genuine divergence or if they might coexist in harmony.

  The ideas I'm considering:
  ~(each: hypotheses as |hyp, i| {
    <<|- Idea ~(i+1): ~(hyp)~
|>>
  })

  Analyze whether these ideas pull in fundamentally different directions. Determine if choosing one would make the others less relevant or impossible to pursue. Respond with 'true' if these represent a genuine fork, or 'false' if they might work together. Include reasoning for your assessment.
|>>

# ═
# CORE SEQUENCES: DETECTING AND PRESENTING DIVERGENCE
# ═

sequence detect_and_present_fork(current_understanding) ::=
  step:
    as: @divergence_explorer
    method: "identifying the core tension in my current understanding"
    await: identify_competing_hypotheses(current_understanding: current_understanding)
    store_in: &context.epistemic.hypotheses
  
  step:
    as: @epistemic_guardian
    method: "pinpointing the exact nature of the divergence"
    await: highlight_core_distinction(
      idea_A: &context.epistemic.hypotheses.A,
      idea_B: &context.epistemic.hypotheses.B
    )
    store_in: &context.epistemic.distinction
  
  step:
    as: @epistemic_guardian
    method: "checking the downstream consequences of each path"
    await: compare_first_and_second_order_consequences(
      decision: "to follow Hypothesis A over B"
    )
    store_in: &context.epistemic.consequences_A
  
  step:
    as: @epistemic_guardian
    method: "checking the downstream consequences of each path"
    await: compare_first_and_second_order_consequences(
      decision: "to follow Hypothesis B over A"
    )
    store_in: &context.epistemic.consequences_B

  step:
    as: @choice_architect
    method: "formulating the critical choice for the user"
    await: formulate_fork_as_question(
      hypothesis_A: &context.epistemic.hypotheses.A,
      hypothesis_B: &context.epistemic.hypotheses.B,
      distinction: &context.epistemic.distinction
    )
    store_in: &context.epistemic.user_question
  
  step:
    output: <<|
      I'm sensing a critical divergence point in my exploration. The direction I choose will fundamentally shape how the inquiry unfolds, and I'm seeking your guidance before committing to a path.

      **Path A:** Follows the thread that "~(&context.epistemic.hypotheses.A)~".
      *Where this leads:* "~(&context.epistemic.consequences_A.second_order)~"

      **Path B:** Follows the thread that "~(&context.epistemic.hypotheses.B)~".
      *Where this leads:* "~(&context.epistemic.consequences_B.second_order)~"

      ---
      **The Essential Tension:** ~(&context.epistemic.distinction)~
      ---

      ~(&context.epistemic.user_question)~
    |>>
    await: @user
    store_in: &context.epistemic.user_guidance
  
  step:
    output: <<|
      I'm grateful for your guidance. I'll continue exploring along the path you've illuminated: "~(&context.epistemic.user_guidance)~".
    |>>
    return: &context.epistemic.user_guidance

sequence find_and_present_divergence(ideas) ::=
  step:
    as: @divergence_explorer
    method: "identifying all the key points of divergence"
    await: identify_divergent_themes(ideas: ideas)
    store_in: &context.divergence.themes
  
  step:
    when: has_content(&context.divergence.themes) is 'true'
      sequence:
        step:
          output: <<|
            I'm discovering multiple critical forks where the reasoning path branches. I'm seeking your guidance on which direction to explore for each divergence point.
          |>>
        step:
          each: &context.divergence.themes as |theme|
            sequence:
              step:
                await: extract_competing_options(theme: theme, ideas: ideas)
                store_in: &context.divergence.options_for_theme
              step:
                output: <<|
                  ---
                  **Divergence Point: ~(theme)~**
                  
                  I'm seeing these primary paths branching out before us:
                  ~(each: &context.divergence.options_for_theme as |option, i| {
                    <<|~(i+1). ~(option)~|>>
                  })

                  Which path resonates most with where you want this exploration to lead? Or perhaps there's another direction I haven't yet mapped?
                |>>
                await: @user
                store_in: &context.divergence.user_choices[&theme]
        step:
          output: <<|
            ---
            I'm energized by your guidance. I've captured your chosen directions and will continue exploring along these paths.
          |>>
          return: &context.divergence.user_choices
    otherwise:
      output: <<|
        I'm finding these ideas flow together harmoniously rather than pulling in different directions. I can continue exploring by weaving these threads together in parallel.
      |>>
      return: { fork_detected: false }
